From 04991ef83b7ef9bd675ca8b7f6ff86b6199785f4 Mon Sep 17 00:00:00 2001
From: "Jack Reacher (JR94)" <jackreacher1994@gmail.com>
Date: Tue, 11 Jun 2019 20:24:33 +0700
Subject: [PATCH] Fix check signature medical test

---
 app/Http/Controllers/DoctorController.php.rej | 134 ----------
 app/Http/Controllers/HomeController.php       |   2 +-
 app/Http/Controllers/HomeController.php.rej   | 250 ------------------
 app/Http/Controllers/StaffController.php.rej  |  92 -------
 resources/views/doctor/medical_exam.blade.php |   4 +-
 .../views/doctor/medical_exam.blade.php.rej   |  83 ------
 resources/views/patient/history.blade.php.rej |  75 ------
 .../patient/history_health.blade.php.rej      |  37 ---
 .../views/patient/history_test.blade.php.rej  |  37 ---
 resources/views/staff/COPD_test.blade.php     |   2 +-
 resources/views/staff/COPD_test.blade.php.rej |  88 ------
 resources/views/staff/medical_test.blade.php  |   2 +-
 .../views/staff/medical_test.blade.php.rej    |  86 ------
 13 files changed, 5 insertions(+), 887 deletions(-)
 delete mode 100755 app/Http/Controllers/DoctorController.php.rej
 delete mode 100755 app/Http/Controllers/HomeController.php.rej
 delete mode 100755 app/Http/Controllers/StaffController.php.rej
 delete mode 100755 resources/views/doctor/medical_exam.blade.php.rej
 delete mode 100755 resources/views/patient/history.blade.php.rej
 delete mode 100755 resources/views/patient/history_health.blade.php.rej
 delete mode 100755 resources/views/patient/history_test.blade.php.rej
 delete mode 100755 resources/views/staff/COPD_test.blade.php.rej
 delete mode 100755 resources/views/staff/medical_test.blade.php.rej

diff --git a/app/Http/Controllers/DoctorController.php.rej b/app/Http/Controllers/DoctorController.php.rej
deleted file mode 100755
index c5f0bb3..0000000
--- a/app/Http/Controllers/DoctorController.php.rej
+++ /dev/null
@@ -1,134 +0,0 @@
-diff a/app/Http/Controllers/DoctorController.php b/app/Http/Controllers/DoctorController.php	(rejected hunks)
-@@ -11,6 +11,7 @@ use App\Http\Requests\MedicalApplicationRequest;
- use App\Model\MedicalApplication;
- use App\Model\MedicalSpecialistApplication;
- use App\Model\MedicalTestApplication;
-+use App\Model\Certificate;
- use App\Model\Patient;
- use App\User;
- use App\Model\Role;
-@@ -384,6 +385,29 @@ class DoctorController extends Controller {
-         $medical_id = $request->input('medicalID');
- 
-         if ($oauth->checkResource($medical_id)) {
-+            $inputCertificate = $request->input('certificate');
-+            $pemCertificate = chunk_split($inputCertificate, 64, "\n");
-+            $pemCertificate = "-----BEGIN CERTIFICATE-----\n" . $pemCertificate . "-----END CERTIFICATE-----\n";
-+            $certificate = Certificate::where('serial_number', openssl_x509_parse($pemCertificate)['serialNumber'])->first();
-+            $doctorId = Auth::id();
-+            $signature = $request->input('signatureValue');
-+            $signDatetime = $request->input('signDatetime');
-+
-+            if(is_null($certificate))
-+                return redirect()->route('medical_exam_by_id', ['id' => $medical_id])->with(['flash_message' => 'Chứng thư số dùng để ký chưa được đăng ký với hệ thống!', 'message_level' => 'danger']);
-+
-+            if($certificate->status != 0)
-+                return redirect()->route('medical_exam_by_id', ['id' => $medical_id])->with(['flash_message' => 'Chứng thư số dùng để ký đã bị thu hồi!', 'message_level' => 'danger']);
-+
-+            if($certificate->user_id != $doctorId)
-+                return redirect()->route('medical_exam_by_id', ['id' => $medical_id])->with(['flash_message' => 'Chứng thư số dùng để ký không thuộc về bác sĩ!', 'message_level' => 'danger']);
-+
-+            $from = strtotime($certificate->valid_from_time);
-+            $to = strtotime($certificate->valid_to_time);
-+            $now = time();
-+            if($from > $now || $to < $now)
-+                return redirect()->route('medical_exam_by_id', ['id' => $medical_id])->with(['flash_message' => 'Chứng thư số dùng để ký đã hết hạn!', 'message_level' => 'danger']);
-+
-             $medical = MedicalApplication::where('id', $medical_id)->first();
-             $contents = Storage::get($medical->url);
-             $medical_application_xml = simplexml_load_string($contents);
-@@ -395,6 +419,11 @@ class DoctorController extends Controller {
-                 $medical_application_xml->kham_the_luc->can_nang = $can_nang;
-                 $huyet_ap = $request->input('huyet_ap');
-                 $medical_application_xml->kham_the_luc->huyet_ap = $huyet_ap;
-+
-+                $medical_application_xml->kham_the_luc->chu_ky = $signature;
-+                $medical_application_xml->kham_the_luc->bac_si_ky = $doctorId;
-+                $medical_application_xml->kham_the_luc->thoi_diem_ky = $signDatetime;
-+                $medical_application_xml->kham_the_luc->chung_thu_ky = $inputCertificate;
-             }
- 
-             if ($oauth->checkPermission(Permission::NK_PERMISSION)) {
-@@ -437,6 +466,11 @@ class DoctorController extends Controller {
-                 $medical_application_xml->kham_lam_sang->noi_khoa->tam_than = $tam_than;
-                 $phan_loai_tam_than = $request->input('phan_loai_tam_than');
-                 $medical_application_xml->kham_lam_sang->noi_khoa->phan_loai_tam_than = $phan_loai_tam_than;
-+
-+                $medical_application_xml->kham_lam_sang->noi_khoa->chu_ky = $signature;
-+                $medical_application_xml->kham_lam_sang->noi_khoa->bac_si_ky = $doctorId;
-+                $medical_application_xml->kham_lam_sang->noi_khoa->thoi_diem_ky = $signDatetime;
-+                $medical_application_xml->kham_lam_sang->noi_khoa->chung_thu_ky = $inputCertificate;
-             }
- 
-             if ($oauth->checkPermission(Permission::MAT_PERMISSION)) {
-@@ -448,6 +482,11 @@ class DoctorController extends Controller {
-                 $medical_application_xml->kham_lam_sang->mat->benh_neu_co = $benh_ve_mat;
-                 $phan_loai_mat = $request->input('phan_loai_mat');
-                 $medical_application_xml->kham_lam_sang->mat->phan_loai = $phan_loai_mat;
-+
-+                $medical_application_xml->kham_lam_sang->mat->chu_ky = $signature;
-+                $medical_application_xml->kham_lam_sang->mat->bac_si_ky = $doctorId;
-+                $medical_application_xml->kham_lam_sang->mat->thoi_diem_ky = $signDatetime;
-+                $medical_application_xml->kham_lam_sang->mat->chung_thu_ky = $inputCertificate;
-             }
- 
-             if ($oauth->checkPermission(Permission::TMH_PERMISSION)) {
-@@ -459,6 +498,11 @@ class DoctorController extends Controller {
-                 $medical_application_xml->kham_lam_sang->tai_mui_hong->benh_neu_co = $benh_ve_mat;
-                 $phan_loai_tai_mui_hong = $request->input('phan_loai_tai_mui_hong');
-                 $medical_application_xml->kham_lam_sang->tai_mui_hong->phan_loai = $phan_loai_tai_mui_hong;
-+
-+                $medical_application_xml->kham_lam_sang->tai_mui_hong->chu_ky = $signature;
-+                $medical_application_xml->kham_lam_sang->tai_mui_hong->bac_si_ky = $doctorId;
-+                $medical_application_xml->kham_lam_sang->tai_mui_hong->thoi_diem_ky = $signDatetime;
-+                $medical_application_xml->kham_lam_sang->tai_mui_hong->chung_thu_ky = $inputCertificate;
-             }
- 
-             if ($oauth->checkPermission(Permission::RHM_PERMISSION)) {
-@@ -468,11 +512,21 @@ class DoctorController extends Controller {
-                 $medical_application_xml->kham_lam_sang->rang_ham_mat->ham_duoi = $ham_duoi;
-                 $phan_loai_rang_ham_mat = $request->input('phan_loai_rang_ham_mat');
-                 $medical_application_xml->kham_lam_sang->rang_ham_mat->phan_loai = $phan_loai_rang_ham_mat;
-+
-+                $medical_application_xml->kham_lam_sang->rang_ham_mat->chu_ky = $signature;
-+                $medical_application_xml->kham_lam_sang->rang_ham_mat->bac_si_ky = $doctorId;
-+                $medical_application_xml->kham_lam_sang->rang_ham_mat->thoi_diem_ky = $signDatetime;
-+                $medical_application_xml->kham_lam_sang->rang_ham_mat->chung_thu_ky = $inputCertificate;
-             }
- 
-             if ($oauth->checkPermission(Permission::DL_PERMISSION)) {
-                 $phan_loai_da_lieu = $request->input('phan_loai_da_lieu');
-                 $medical_application_xml->kham_lam_sang->da_lieu->phan_loai = $phan_loai_da_lieu;
-+
-+                $medical_application_xml->kham_lam_sang->da_lieu->chu_ky = $signature;
-+                $medical_application_xml->kham_lam_sang->da_lieu->bac_si_ky = $doctorId;
-+                $medical_application_xml->kham_lam_sang->da_lieu->thoi_diem_ky = $signDatetime;
-+                $medical_application_xml->kham_lam_sang->da_lieu->chung_thu_ky = $inputCertificate;
-             }
- 
-             if ($oauth->checkPermission(Permission::CLS_PERMISSION)) {
-@@ -480,6 +534,11 @@ class DoctorController extends Controller {
-                 $medical_application_xml->kham_can_lam_sang->ket_qua = $ket_qua;
-                 $danh_gia = $request->input('danh_gia');
-                 $medical_application_xml->kham_can_lam_sang->danh_gia = $danh_gia;
-+
-+                $medical_application_xml->kham_can_lam_sang->chu_ky = $signature;
-+                $medical_application_xml->kham_can_lam_sang->bac_si_ky = $doctorId;
-+                $medical_application_xml->kham_can_lam_sang->thoi_diem_ky = $signDatetime;
-+                $medical_application_xml->kham_can_lam_sang->chung_thu_ky = $inputCertificate;
-             }
- 
-             if ($oauth->checkPermission(Permission::TQ_PERMISSION)) {
-@@ -487,6 +546,12 @@ class DoctorController extends Controller {
-                 $medical_application_xml->ket_luan->phan_loai = $phan_loai;
-                 $benh_neu_co = $request->input('benh_neu_co');
-                 $medical_application_xml->ket_luan->benh_neu_co = $benh_neu_co;
-+
-+                $medical_application_xml->ket_luan->chu_ky = $signature;
-+                $medical_application_xml->ket_luan->bac_si_ky = $doctorId;
-+                $medical_application_xml->ket_luan->thoi_diem_ky = $signDatetime;
-+                $medical_application_xml->ket_luan->chung_thu_ky = $inputCertificate;
-+
-                 if ($benh_neu_co) {
-                     $medical->status = 0;
-                     $medical->save();
diff --git a/app/Http/Controllers/HomeController.php b/app/Http/Controllers/HomeController.php
index d810bc1..117fc3e 100755
--- a/app/Http/Controllers/HomeController.php
+++ b/app/Http/Controllers/HomeController.php
@@ -292,7 +292,7 @@ class HomeController extends Controller
 
                 if($this->checkCertificateExpired($certificate))
                     return 'Chứng thư số dùng để ký có ID '.$phe_dung->chung_thu_ky.' đã hết hạn!';
-
+                    
                 if(! $this->checkSignature($originValue, $phe_dung->chu_ky, $certificate))
                     return 'Phiếu xét nghiệm đã bị sửa đổi trái phép!';
             }
diff --git a/app/Http/Controllers/HomeController.php.rej b/app/Http/Controllers/HomeController.php.rej
deleted file mode 100755
index 6af2d84..0000000
--- a/app/Http/Controllers/HomeController.php.rej
+++ /dev/null
@@ -1,250 +0,0 @@
-diff a/app/Http/Controllers/HomeController.php b/app/Http/Controllers/HomeController.php	(rejected hunks)
-@@ -7,6 +7,11 @@ use Illuminate\Support\Facades\Auth;
- use App\RBACController\UserManagement;
- use Giaptt\Oidcda\Authen;
- use App\Http\Requests;
-+use App\Model\MedicalApplication;
-+use App\Model\MedicalTestApplication;
-+use App\Model\User;
-+use App\Model\Certificate;
-+use Storage;
- 
- class HomeController extends Controller
- {
-@@ -47,4 +52,236 @@ class HomeController extends Controller
-         return response()->json(array('msg' => $msg), 200);
-    
-     }
-+
-+    public function checkCertNotBelongToUser($userId, $certId) {
-+        return User::findOrFail($userId)->certificates->where('id', $certId)->count() == 0;
-+    }
-+
-+    public function checkCertificateExpired($certificate) {
-+        $from = strtotime($certificate->valid_from_time);
-+        $to = strtotime($certificate->valid_to_time);
-+        $now = time();
-+        return ($from > $now || $to < $now);
-+    }
-+
-+    public function checkSignature($message, $signature, $certificate) {
-+        $publicKey = openssl_pkey_get_details(openssl_pkey_get_public($certificate->certificate))['key'];
-+        return openssl_verify($message, base64_decode($signature), $publicKey);
-+    }
-+
-+    public function checkMedicalApplication($id) {
-+        $medical = MedicalApplication::findOrFail($id);
-+        try {
-+            $contents = Storage::get($medical->url);
-+        } catch (\Exception $e) {
-+            return "Không tìm thấy file đơn khám";
-+        }
-+        $medical_application_xml = simplexml_load_string($contents);
-+
-+        $kham_the_luc = $medical_application_xml->kham_the_luc;
-+        if(!empty($kham_the_luc->chu_ky)) {
-+            $originValue = $kham_the_luc->chieu_cao . $kham_the_luc->can_nang . $kham_the_luc->huyet_ap . $kham_the_luc->bac_si_ky . $kham_the_luc->thoi_diem_ky;
-+            $certificate = Certificate::findOrFail($kham_the_luc->chung_thu_ky);
-+
-+            if($this->checkCertNotBelongToDoctor($kham_the_luc->bac_si_ky, $kham_the_luc->chung_thu_ky))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_the_luc->chung_thu_ky.' không thuộc về bác sĩ '.User::findOrFail($kham_the_luc->bac_si_ky)->name.'!';
-+
-+            if($certificate->status != 0)
-+                return 'Chứng thư số dùng để ký có ID '.$kham_the_luc->chung_thu_ky.' đã bị thu hồi!';
-+
-+            if($this->checkCertificateExpired($certificate))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_the_luc->chung_thu_ky.' đã hết hạn!';
-+
-+            if(! $this->checkSignature($originValue, $kham_the_luc->chu_ky, $certificate))
-+                return 'Đơn khám đã bị sửa đổi trái phép!';
-+        }
-+
-+        $kham_lam_sang_noi_khoa = $medical_application_xml->kham_lam_sang->noi_khoa;
-+        if(!empty($kham_lam_sang_noi_khoa->chu_ky)) {
-+            $originValue = $kham_lam_sang_noi_khoa->tuan_hoan . $kham_lam_sang_noi_khoa->phan_loai_tuan_hoan . $kham_lam_sang_noi_khoa->tieu_hoa . $kham_lam_sang_noi_khoa->phan_loai_tieu_hoa . $kham_lam_sang_noi_khoa->ho_hap . $kham_lam_sang_noi_khoa->phan_loai_ho_hap . $kham_lam_sang_noi_khoa->noi_tiet . $kham_lam_sang_noi_khoa->phan_loai_noi_tiet . $kham_lam_sang_noi_khoa->than_tiet_nieu . $kham_lam_sang_noi_khoa->phan_loai_than_tiet_nieu . $kham_lam_sang_noi_khoa->co_xuong_khop . $kham_lam_sang_noi_khoa->phan_loai_co_xuong_khop . $kham_lam_sang_noi_khoa->than_kinh . $kham_lam_sang_noi_khoa->phan_loai_than_kinh . $kham_lam_sang_noi_khoa->tam_than . $kham_lam_sang_noi_khoa->phan_loai_tam_than . $kham_lam_sang_noi_khoa->bac_si_ky . $kham_lam_sang_noi_khoa->thoi_diem_ky;
-+            $certificate = Certificate::findOrFail($kham_lam_sang_noi_khoa->chung_thu_ky);
-+
-+            if($this->checkCertNotBelongToDoctor($kham_lam_sang_noi_khoa->bac_si_ky, $kham_lam_sang_noi_khoa->chung_thu_ky))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_lam_sang_noi_khoa->chung_thu_ky.' không thuộc về bác sĩ '.User::findOrFail($kham_the_luc->bac_si_ky)->name.'!';
-+
-+            if($certificate->status != 0)
-+                return 'Chứng thư số dùng để ký có ID '.$kham_lam_sang_noi_khoa->chung_thu_ky.' đã bị thu hồi!';
-+
-+            if($this->checkCertificateExpired($certificate))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_lam_sang_noi_khoa->chung_thu_ky.' đã hết hạn!';
-+
-+            if(! $this->checkSignature($originValue, $kham_lam_sang_noi_khoa->chu_ky, $certificate))
-+                return 'Đơn khám đã bị sửa đổi trái phép!';
-+        }
-+
-+        $kham_lam_sang_mat = $medical_application_xml->kham_lam_sang->mat;
-+        if(!empty($kham_lam_sang_mat->chu_ky)) {
-+            $originValue = $kham_lam_sang_mat->thi_luc->mat_trai . $kham_lam_sang_mat->thi_luc->mat_phai . $kham_lam_sang_mat->benh_neu_co . $kham_lam_sang_mat->phan_loai . $kham_lam_sang_mat->bac_si_ky . $kham_lam_sang_mat->thoi_diem_ky;
-+            $certificate = Certificate::findOrFail($kham_lam_sang_mat->chung_thu_ky);
-+
-+            if($this->checkCertNotBelongToDoctor($kham_lam_sang_mat->bac_si_ky, $kham_lam_sang_mat->chung_thu_ky))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_lam_sang_mat->chung_thu_ky.' không thuộc về bác sĩ '.User::findOrFail($kham_lam_sang_mat->bac_si_ky)->name.'!';
-+
-+            if($certificate->status != 0)
-+                return 'Chứng thư số dùng để ký có ID '.$kham_lam_sang_mat->chung_thu_ky.' đã bị thu hồi!';
-+
-+            if($this->checkCertificateExpired($certificate))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_lam_sang_mat->chung_thu_ky.' đã hết hạn!';
-+
-+            if(! $this->checkSignature($originValue, $kham_lam_sang_mat->chu_ky, $certificate))
-+                return 'Đơn khám đã bị sửa đổi trái phép!';
-+        }
-+
-+        $kham_lam_sang_tai_mui_hong = $medical_application_xml->kham_lam_sang->tai_mui_hong;
-+        if(!empty($kham_lam_sang_tai_mui_hong->chu_ky)) {
-+            $originValue = $kham_lam_sang_tai_mui_hong->thinh_luc->tai_trai . $kham_lam_sang_tai_mui_hong->thinh_luc->tai_phai . $kham_lam_sang_tai_mui_hong->benh_neu_co . $kham_lam_sang_tai_mui_hong->phan_loai . $kham_lam_sang_tai_mui_hong->bac_si_ky . $kham_lam_sang_tai_mui_hong->thoi_diem_ky;
-+            $certificate = Certificate::findOrFail($kham_lam_sang_tai_mui_hong->chung_thu_ky);
-+
-+            if($this->checkCertNotBelongToDoctor($kham_lam_sang_tai_mui_hong->bac_si_ky, $kham_lam_sang_tai_mui_hong->chung_thu_ky))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_lam_sang_tai_mui_hong->chung_thu_ky.' không thuộc về bác sĩ '.User::findOrFail($kham_lam_sang_tai_mui_hong->bac_si_ky)->name.'!';
-+
-+            if($certificate->status != 0)
-+                return 'Chứng thư số dùng để ký có ID '.$kham_lam_sang_tai_mui_hong->chung_thu_ky.' đã bị thu hồi!';
-+
-+            if($this->checkCertificateExpired($certificate))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_lam_sang_tai_mui_hong->chung_thu_ky.' đã hết hạn!';
-+
-+            if(! $this->checkSignature($originValue, $kham_lam_sang_tai_mui_hong->chu_ky, $certificate))
-+                return 'Đơn khám đã bị sửa đổi trái phép!';
-+        }
-+
-+        $kham_lam_sang_rang_ham_mat = $medical_application_xml->kham_lam_sang->rang_ham_mat;
-+        if(!empty($kham_lam_sang_rang_ham_mat->chu_ky)) {
-+            $originValue = $kham_lam_sang_rang_ham_mat->ham_tren . $kham_lam_sang_rang_ham_mat->ham_duoi . $kham_lam_sang_rang_ham_mat->phan_loai . $kham_lam_sang_rang_ham_mat->bac_si_ky . $kham_lam_sang_rang_ham_mat->thoi_diem_ky;
-+            $certificate = Certificate::findOrFail($kham_lam_sang_rang_ham_mat->chung_thu_ky);
-+
-+            if($this->checkCertNotBelongToDoctor($kham_lam_sang_rang_ham_mat->bac_si_ky, $kham_lam_sang_rang_ham_mat->chung_thu_ky))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_lam_sang_rang_ham_mat->chung_thu_ky.' không thuộc về bác sĩ '.User::findOrFail($kham_lam_sang_rang_ham_mat->bac_si_ky)->name.'!';
-+
-+            if($certificate->status != 0)
-+                return 'Chứng thư số dùng để ký có ID '.$kham_lam_sang_rang_ham_mat->chung_thu_ky.' đã bị thu hồi!';
-+
-+            if($this->checkCertificateExpired($certificate))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_lam_sang_rang_ham_mat->chung_thu_ky.' đã hết hạn!';
-+
-+            if(! $this->checkSignature($originValue, $kham_lam_sang_rang_ham_mat->chu_ky, $certificate))
-+                return 'Đơn khám đã bị sửa đổi trái phép!';
-+        }
-+
-+        $kham_lam_sang_da_lieu = $medical_application_xml->kham_lam_sang->da_lieu;
-+        if(!empty($kham_lam_sang_da_lieu->chu_ky)) {
-+            $originValue = $kham_lam_sang_da_lieu->phan_loai . $kham_lam_sang_da_lieu->bac_si_ky . $kham_lam_sang_da_lieu->thoi_diem_ky;
-+            $certificate = Certificate::findOrFail($kham_lam_sang_da_lieu->chung_thu_ky);
-+
-+            if($this->checkCertNotBelongToDoctor($kham_lam_sang_da_lieu->bac_si_ky, $kham_lam_sang_da_lieu->chung_thu_ky))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_lam_sang_da_lieu->chung_thu_ky.' không thuộc về bác sĩ '.User::findOrFail($kham_lam_sang_da_lieu->bac_si_ky)->name.'!';
-+
-+            if($certificate->status != 0)
-+                return 'Chứng thư số dùng để ký có ID '.$kham_lam_sang_da_lieu->chung_thu_ky.' đã bị thu hồi!';
-+
-+            if($this->checkCertificateExpired($certificate))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_lam_sang_da_lieu->chung_thu_ky.' đã hết hạn!';
-+
-+            if(! $this->checkSignature($originValue, $kham_lam_sang_da_lieu->chu_ky, $certificate))
-+                return 'Đơn khám đã bị sửa đổi trái phép!';
-+        }
-+
-+        $kham_can_lam_sang = $medical_application_xml->kham_can_lam_sang;
-+        if(!empty($kham_can_lam_sang->chu_ky)) {
-+            $originValue = $kham_can_lam_sang->ket_qua . $kham_can_lam_sang->danh_gia . $kham_can_lam_sang->bac_si_ky . $kham_can_lam_sang->thoi_diem_ky;
-+            $certificate = Certificate::findOrFail($kham_can_lam_sang->chung_thu_ky);
-+
-+            if($this->checkCertNotBelongToDoctor($kham_can_lam_sang->bac_si_ky, $kham_can_lam_sang->chung_thu_ky))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_can_lam_sang->chung_thu_ky.' không thuộc về bác sĩ '.User::findOrFail($kham_can_lam_sang->bac_si_ky)->name.'!';
-+
-+            if($certificate->status != 0)
-+                return 'Chứng thư số dùng để ký có ID '.$kham_can_lam_sang->chung_thu_ky.' đã bị thu hồi!';
-+
-+            if($this->checkCertificateExpired($certificate))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_can_lam_sang->chung_thu_ky.' đã hết hạn!';
-+
-+            if(! $this->checkSignature($originValue, $kham_can_lam_sang->chu_ky, $certificate))
-+                return 'Đơn khám đã bị sửa đổi trái phép!';
-+        }
-+
-+        $ket_luan = $medical_application_xml->ket_luan;
-+        if(!empty($ket_luan->chu_ky)) {
-+            $originValue = $ket_luan->phan_loai . $ket_luan->benh_neu_co . $ket_luan->bac_si_ky . $ket_luan->thoi_diem_ky;
-+            $certificate = Certificate::findOrFail($ket_luan->chung_thu_ky);
-+
-+            if($this->checkCertNotBelongToUser($ket_luan->bac_si_ky, $ket_luan->chung_thu_ky))
-+                return 'Chứng thư số dùng để ký có ID '.$ket_luan->chung_thu_ky.' không thuộc về bác sĩ '.User::findOrFail($ket_luan->bac_si_ky)->name.'!';
-+
-+            if($certificate->status != 0)
-+                return 'Chứng thư số dùng để ký có ID '.$ket_luan->chung_thu_ky.' đã bị thu hồi!';
-+
-+            if($this->checkCertificateExpired($certificate))
-+                return 'Chứng thư số dùng để ký có ID '.$ket_luan->chung_thu_ky.' đã hết hạn!';
-+
-+            if(! $this->checkSignature($originValue, $ket_luan->chu_ky, $certificate))
-+                return 'Đơn khám đã bị sửa đổi trái phép!';
-+        }
-+
-+        return 'Đơn khám hợp lệ!';
-+    }
-+
-+    public function checkCOPDApplication($id) {
-+        $medical = MedicalTestApplication::findOrFail($id);
-+        try {
-+            $contents = Storage::get($medical->url);
-+        } catch (\Exception $e) {
-+            return "Không tìm thấy file phiếu đo";
-+        }
-+        $medical_application_xml = simplexml_load_string($contents);
-+
-+        $phe_dung = $medical_application_xml->phe_dung;
-+        if(!empty($phe_dung->chu_ky)) {
-+            $originValue = $phe_dung->FVC . $phe_dung->FEV1 . $phe_dung->PEF . $phe_dung->nhan_vien_ky . $phe_dung->thoi_diem_ky;
-+            $certificate = Certificate::findOrFail($phe_dung->chung_thu_ky);
-+
-+            if($this->checkCertNotBelongToUser($phe_dung->nhan_vien_ky, $phe_dung->chung_thu_ky))
-+                return 'Chứng thư số dùng để ký có ID '.$phe_dung->chung_thu_ky.' không thuộc về nhân viên '.User::findOrFail($phe_dung->nhan_vien_ky)->name.'!';
-+
-+            if($certificate->status != 0)
-+                return 'Chứng thư số dùng để ký có ID '.$phe_dung->chung_thu_ky.' đã bị thu hồi!';
-+
-+            if($this->checkCertificateExpired($certificate))
-+                return 'Chứng thư số dùng để ký có ID '.$phe_dung->chung_thu_ky.' đã hết hạn!';
-+
-+            if(! $this->checkSignature($originValue, $phe_dung->chu_ky, $certificate))
-+                return 'Phiếu đo đã bị sửa đổi trái phép!';
-+        }
-+
-+        return 'Phiếu đo hợp lệ!';
-+    }
-+
-+    public function checkMedicalTestApplication($id) {
-+        $medical = MedicalTestApplication::findOrFail($id);
-+        try {
-+            $contents = Storage::get($medical->url);
-+        } catch (\Exception $e) {
-+            return "Không tìm thấy file đơn khám";
-+        }
-+        $medical_application_xml = simplexml_load_string($contents);
-+
-+        $kham_the_luc = $medical_application_xml->kham_the_luc;
-+        if(!empty($kham_the_luc->chu_ky)) {
-+            $originValue = $kham_the_luc->chieu_cao . $kham_the_luc->can_nang . $kham_the_luc->huyet_ap . $kham_the_luc->nhan_vien_ky . $kham_the_luc->thoi_diem_ky;
-+            $certificate = Certificate::findOrFail($kham_the_luc->chung_thu_ky);
-+
-+            if($this->checkCertNotBelongToUser($kham_the_luc->nhan_vien_ky, $kham_the_luc->chung_thu_ky))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_the_luc->chung_thu_ky.' không thuộc về nhân viên '.User::findOrFail($kham_the_luc->nhan_vien_ky)->name.'!';
-+
-+            if($certificate->status != 0)
-+                return 'Chứng thư số dùng để ký có ID '.$kham_the_luc->chung_thu_ky.' đã bị thu hồi!';
-+
-+            if($this->checkCertificateExpired($certificate))
-+                return 'Chứng thư số dùng để ký có ID '.$kham_the_luc->chung_thu_ky.' đã hết hạn!';
-+
-+            if(! $this->checkSignature($originValue, $kham_the_luc->chu_ky, $certificate))
-+                return 'Đơn khám đo đã bị sửa đổi trái phép!';
-+        }
-+
-+        return 'Đơn khám hợp lệ!';
-+    }
- }
diff --git a/app/Http/Controllers/StaffController.php.rej b/app/Http/Controllers/StaffController.php.rej
deleted file mode 100755
index 12ecbe6..0000000
--- a/app/Http/Controllers/StaffController.php.rej
+++ /dev/null
@@ -1,92 +0,0 @@
-diff a/app/Http/Controllers/StaffController.php b/app/Http/Controllers/StaffController.php	(rejected hunks)
-@@ -6,6 +6,7 @@ use Illuminate\Http\Request;
- use App\Model\MedicalApplication;
- use App\Model\MedicalTestApplication;
- use App\Model\MedicalSpecialistApplication;
-+use App\Model\Certificate;
- use App\Model\Permission;
- use App\Model\Role;
- use App\Model\Patient;
-@@ -534,6 +535,28 @@ class StaffController extends Controller {
- 
- //ghi dữ liệu xét nghiệm
-     public function updateTestMedicalInfo(Request $request) {
-+        $inputCertificate = $request->input('certificate');
-+        $pemCertificate = chunk_split($inputCertificate, 64, "\n");
-+        $pemCertificate = "-----BEGIN CERTIFICATE-----\n" . $pemCertificate . "-----END CERTIFICATE-----\n";
-+        $certificate = Certificate::where('serial_number', openssl_x509_parse($pemCertificate)['serialNumber'])->first();
-+        $staffId = Auth::id();
-+        $signature = $request->input('signatureValue');
-+        $signDatetime = $request->input('signDatetime');
-+
-+        if(is_null($certificate))
-+            return redirect()->route('medical_exam_by_id', ['id' => $medical_id])->with(['flash_message' => 'Chứng thư số dùng để ký chưa được đăng ký với hệ thống!', 'message_level' => 'danger']);
-+
-+        if($certificate->status != 0)
-+            return redirect()->route('medical_exam_by_id', ['id' => $medical_id])->with(['flash_message' => 'Chứng thư số dùng để ký đã bị thu hồi!', 'message_level' => 'danger']);
-+
-+        if($certificate->user_id != $staffId)
-+            return redirect()->route('medical_exam_by_id', ['id' => $medical_id])->with(['flash_message' => 'Chứng thư số dùng để ký không thuộc về nhân viên!', 'message_level' => 'danger']);
-+
-+        $from = strtotime($certificate->valid_from_time);
-+        $to = strtotime($certificate->valid_to_time);
-+        $now = time();
-+        if($from > $now || $to < $now)
-+            return redirect()->route('medical_exam_by_id', ['id' => $medical_id])->with(['flash_message' => 'Chứng thư số dùng để ký đã hết hạn!', 'message_level' => 'danger']);
- 
-         $medical_id = $request->input('medicalID');
-         $medical = MedicalTestApplication::join('medical_test_type', 'medical_test_applications.xetnghiem', '=', 'medical_test_type.id')
-@@ -549,6 +572,12 @@ class StaffController extends Controller {
-         $medical_application_xml->kham_the_luc->can_nang = $can_nang;
-         $huyet_ap = $request->input('huyet_ap');
-         $medical_application_xml->kham_the_luc->huyet_ap = $huyet_ap;
-+
-+        $medical_application_xml->kham_the_luc->chu_ky = $signature;
-+        $medical_application_xml->kham_the_luc->nhan_vien_ky = $staffId;
-+        $medical_application_xml->kham_the_luc->thoi_diem_ky = $signDatetime;
-+        $medical_application_xml->kham_the_luc->chung_thu_ky = $inputCertificate;
-+
-         $check = $request->input('checkSubmit');
- 
-         $method = config('encrypt.method');
-@@ -584,6 +613,28 @@ class StaffController extends Controller {
-     }
- 
-     public function updateCOPDTestMedicalInfo(Request $request) {
-+        $inputCertificate = $request->input('certificate');
-+        $pemCertificate = chunk_split($inputCertificate, 64, "\n");
-+        $pemCertificate = "-----BEGIN CERTIFICATE-----\n" . $pemCertificate . "-----END CERTIFICATE-----\n";
-+        $certificate = Certificate::where('serial_number', openssl_x509_parse($pemCertificate)['serialNumber'])->first();
-+        $staffId = Auth::id();
-+        $signature = $request->input('signatureValue');
-+        $signDatetime = $request->input('signDatetime');
-+
-+        if(is_null($certificate))
-+            return redirect()->route('medical_exam_by_id', ['id' => $medical_id])->with(['flash_message' => 'Chứng thư số dùng để ký chưa được đăng ký với hệ thống!', 'message_level' => 'danger']);
-+
-+        if($certificate->status != 0)
-+            return redirect()->route('medical_exam_by_id', ['id' => $medical_id])->with(['flash_message' => 'Chứng thư số dùng để ký đã bị thu hồi!', 'message_level' => 'danger']);
-+
-+        if($certificate->user_id != $staffId)
-+            return redirect()->route('medical_exam_by_id', ['id' => $medical_id])->with(['flash_message' => 'Chứng thư số dùng để ký không thuộc về nhân viên!', 'message_level' => 'danger']);
-+
-+        $from = strtotime($certificate->valid_from_time);
-+        $to = strtotime($certificate->valid_to_time);
-+        $now = time();
-+        if($from > $now || $to < $now)
-+            return redirect()->route('medical_exam_by_id', ['id' => $medical_id])->with(['flash_message' => 'Chứng thư số dùng để ký đã hết hạn!', 'message_level' => 'danger']);
- 
-         $medical_id = $request->input('medicalID');
-         $medical = MedicalTestApplication::join('medical_test_type', 'medical_test_applications.xetnghiem', '=', 'medical_test_type.id')
-@@ -609,6 +660,11 @@ class StaffController extends Controller {
-         $PEF = $request->input('PEF');
-         $medical_application_xml->phe_dung->PEF = $PEF;
- 
-+        $medical_application_xml->phe_dung->chu_ky = $signature;
-+        $medical_application_xml->phe_dung->nhan_vien_ky = $staffId;
-+        $medical_application_xml->phe_dung->thoi_diem_ky = $signDatetime;
-+        $medical_application_xml->phe_dung->chung_thu_ky = $inputCertificate;
-+
-         $id = $request->input('id');
-         $medical_application_xml->thong_tin_ca_nhan->benhnhan_id = $id;
-         $name = $request->input('name');
diff --git a/resources/views/doctor/medical_exam.blade.php b/resources/views/doctor/medical_exam.blade.php
index 01d9540..097b2e4 100755
--- a/resources/views/doctor/medical_exam.blade.php
+++ b/resources/views/doctor/medical_exam.blade.php
@@ -359,7 +359,7 @@
             e.preventDefault();
 
             var originValue = '';
-            $('#medicalExamForm :input:not([type=hidden]):not([readonly]):not([disabled])').each(function (index) {
+            $('#medicalExamForm :input:not([type=hidden]):not([type=checkbox]):not([readonly]):not([disabled])').each(function (index) {
                 originValue += $(this).val();
             });
             originValue += {{ Auth::user()->id }};
@@ -372,7 +372,7 @@
                 + (currentdate.getMonth()+1)  + "/"
                 + currentdate.getFullYear();
 			originValue += time;
-			console.log(originValue);
+			//console.log(originValue);
 
             window.postMessage({
                 type: "CREATE_SIGNATURE_REQUEST",
diff --git a/resources/views/doctor/medical_exam.blade.php.rej b/resources/views/doctor/medical_exam.blade.php.rej
deleted file mode 100755
index 042dde0..0000000
--- a/resources/views/doctor/medical_exam.blade.php.rej
+++ /dev/null
@@ -1,83 +0,0 @@
-diff a/resources/views/doctor/medical_exam.blade.php b/resources/views/doctor/medical_exam.blade.php	(rejected hunks)
-@@ -67,7 +67,7 @@
-     @endif
- </div>
- 
--<form class="form-horizontal" action="{{ route('update-medical-info') }}" enctype="multipart/form-data" method="post">
-+<form class="form-horizontal" action="{{ route('update-medical-info') }}" enctype="multipart/form-data" method="post" id="medicalExamForm">
- <h2 class="col-md-offset-3"> Thông tin bệnh nhân</h2>
-     <div class="form-group">
-         <label class="col-md-2 control-label" style="font-size: 16px"> Họ tên  :</label>
-@@ -342,11 +342,70 @@
-         <div class="form-group">
-         <input type="hidden" name="medicalID" value="<?php echo($medical_id); ?>">
-         <input type="hidden" name="_token" value="{{ csrf_token() }}">
-+		<input type="hidden" id="signatureValue" name="signatureValue">
-+		<input type="hidden" id="signDatetime" name="signDatetime">
-+		<input type="hidden" id="certificate" name="certificate">
-         	<div class="col-md-offset-4">
--        		<button type="submit" class="btn btn-primary btn-lg">Lưu kết quả </button>
-+				<button class="btn btn-primary btn-lg" id="signBtn">Ký số đơn khám</button>
-+        		<button class="btn btn-primary btn-lg" disabled id="saveBtn">Lưu kết quả </button>
-         	</div>
-         </div>
-       
-     </form>
-+<script>
-+    $(document).ready(function(){
- 
-+        $('#signBtn').on('click', function(e){
-+            e.preventDefault();
-+
-+            var originValue = '';
-+            $('#medicalExamForm :input:not([type=hidden]):not([readonly])').each(function (index) {
-+                originValue += $(this).val();
-+            });
-+            originValue += {{ Auth::user()->id }};
-+            var currentdate = new Date();
-+            var time = currentdate.getHours() + ":"
-+                + currentdate.getMinutes() + ":"
-+                + currentdate.getSeconds()
-+                + ' '
-+                + currentdate.getDate() + "/"
-+                + (currentdate.getMonth()+1)  + "/"
-+                + currentdate.getFullYear();
-+			originValue += time;
-+			//console.log(originValue);
-+
-+            window.postMessage({
-+                type: "CREATE_SIGNATURE_REQUEST",
-+                originValue: originValue
-+            }, "*");
-+
-+            window.addEventListener("message", function (event) {
-+                if (event.source != window)
-+                    return;
-+
-+                if (event.data.type && (event.data.type == "CREATE_SIGNATURE_RESPONSE")) {
-+                    if (event.data.success) {
-+                        if (event.data.signature !== null) {
-+                            alert("Đã ký đơn khám!");
-+                            $('#signatureValue').val(event.data.signature);
-+                            $('#signDatetime').val(time);
-+                            $('#certificate').val(event.data.certificate);
-+                            $('#medicalExamForm :input:not([type=hidden]):not([readonly])').each(function (index) {
-+                                $(this).prop("readonly", true);
-+                            });
-+                            $('#signBtn').prop("disabled", true);
-+                            $('#saveBtn').prop("disabled", false);
-+                        } else {
-+                            alert("Chứng thư đã chọn không được dùng để ký!");
-+                        }
-+                    }
-+                    else {
-+                        alert("Ký số đơn khám không thành công!");
-+                    }
-+                }
-+            })
-+        });
-+
-+    });
-+</script>
- @stop
-\ No newline at end of file
diff --git a/resources/views/patient/history.blade.php.rej b/resources/views/patient/history.blade.php.rej
deleted file mode 100755
index 0ef3151..0000000
--- a/resources/views/patient/history.blade.php.rej
+++ /dev/null
@@ -1,75 +0,0 @@
-diff a/resources/views/patient/history.blade.php b/resources/views/patient/history.blade.php	(rejected hunks)
-@@ -116,6 +117,7 @@ Sổ khám bệnh
-                     <th data-field="id"
-                         data-formatter="operateFormatter2"
-                         data-events="operateEvents">Xem chi tiết</th>
-+                    <th data-field="id" data-sortable="false" data-formatter="buttonCheckMedicalTestApplication">Kiểm tra</th>
-                 </tr>
-             </thead>
-         </table>
-@@ -148,6 +150,8 @@ Sổ khám bệnh
-                     </table>
-                 </div>
-                 <div class="modal-footer">
-+                    <button type="button" class="btn btn-default" onclick="checkMedicalApplication($('#medical_application_id').val())">Kiểm tra</button>
-+                    <input type="hidden" id="medical_application_id">
-                     <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
-                 </div>
-             </div><!-- /.modal-content -->
-@@ -178,6 +182,8 @@ Sổ khám bệnh
-                     </table>
-                 </div>
-                 <div class="modal-footer">
-+                    <button type="button" class="btn btn-default" onclick="checkMedicalTestApplication($('#medical_test_application_id').val())">Kiểm tra</button>
-+                    <input type="hidden" id="medical_test_application_id">
-                     <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
-                 </div>
-             </div><!-- /.modal-content -->
-@@ -222,6 +228,7 @@ Sổ khám bệnh
-                 $table.bootstrapTable('refresh', {
-                     url: '../../patient/detail.json/' + value
-                 });
-+                $('#medical_application_id').attr("value", value);
-             },
-             'click .like2': function (e, value, row) {
- 
-@@ -229,6 +236,7 @@ Sổ khám bệnh
-                 $testTable.bootstrapTable('refresh', {
-                     url: '../../patient/testDetail.json/' + value
-                 });
-+                $('#medical_test_application_id').attr("value", value);
-             },
-             'click .remove': function (e, value, row) {
-                 document.getElementById('medical_id').setAttribute("value", value)
-@@ -291,6 +299,30 @@ Sổ khám bệnh
-                 value.substring(0, 10)
-             ]
-         }
-+        function buttonCheckMedicalApplication(value, row, index) {
-+            return [
-+                '<button class="btn btn-default" onClick="checkMedicalApplication(',
-+                value,
-+                ')">Kiểm tra</button>'
-+            ].join('');
-+        }
-+        function checkMedicalApplication(id) {
-+            $.get(baseUrl + '/checkMedicalApplication/' + id, function (data) {
-+                alert(data);
-+            });
-+        }
-+        function buttonCheckMedicalTestApplication(value, row, index) {
-+            return [
-+                '<button class="btn btn-default" onClick="checkMedicalTestApplication(',
-+                value,
-+                ')">Kiểm tra</button>'
-+            ].join('');
-+        }
-+        function checkMedicalTestApplication(id) {
-+            $.get(baseUrl + '/checkMedicalTestApplication/' + id, function (data) {
-+                alert(data);
-+            });
-+        }
-     </script>		
- 
-     @stop
-\ No newline at end of file
diff --git a/resources/views/patient/history_health.blade.php.rej b/resources/views/patient/history_health.blade.php.rej
deleted file mode 100755
index 0b12fcb..0000000
--- a/resources/views/patient/history_health.blade.php.rej
+++ /dev/null
@@ -1,37 +0,0 @@
-diff a/resources/views/patient/history_health.blade.php b/resources/views/patient/history_health.blade.php	(rejected hunks)
-@@ -79,6 +79,7 @@ Sổ khám sức khỏe
-                     <th data-field="id"
-                         data-formatter="operateFormatter"
-                         data-events="operateEvents">Xem chi tiết</th>
-+                    <th data-field="id" data-sortable="false" data-formatter="buttonCheckMedicalApplication">Kiểm tra</th>
-                 </tr>
-             </thead>
-         </table>
-@@ -185,6 +188,7 @@ Sổ khám sức khỏe
-                 $table.bootstrapTable('refresh', {
-                     url: '../../patient/detail.json/' + value
-                 });
-+                $('#medical_application_id').attr("value", value);
-             },
-             'click .like2': function (e, value, row) {
- 
-@@ -254,6 +258,18 @@ Sổ khám sức khỏe
-                 value.substring(0, 10)
-             ]
-         }
-+        function buttonCheckMedicalApplication(value, row, index) {
-+            return [
-+                '<button class="btn btn-default" onClick="checkMedicalApplication(',
-+                value,
-+                ')">Kiểm tra</button>'
-+            ].join('');
-+        }
-+        function checkMedicalApplication(id) {
-+            $.get(baseUrl + '/checkMedicalApplication/' + id, function (data) {
-+                alert(data);
-+            });
-+        }
-     </script>		
- 
-     @stop
-\ No newline at end of file
diff --git a/resources/views/patient/history_test.blade.php.rej b/resources/views/patient/history_test.blade.php.rej
deleted file mode 100755
index 20d3c14..0000000
--- a/resources/views/patient/history_test.blade.php.rej
+++ /dev/null
@@ -1,37 +0,0 @@
-diff a/resources/views/patient/history_test.blade.php b/resources/views/patient/history_test.blade.php	(rejected hunks)
-@@ -78,6 +78,7 @@ Lịch sử xét nghiệm
-                     <th data-field="id"
-                         data-formatter="operateFormatter2"
-                         data-events="operateEvents">Xem chi tiết</th>
-+                    <th data-field="id" data-sortable="false" data-formatter="buttonCheckMedicalTestApplication">Kiểm tra</th>
-                 </tr>
-             </thead>
-         </table>
-@@ -184,6 +187,7 @@ Lịch sử xét nghiệm
-                 $table.bootstrapTable('refresh', {
-                     url: '../../patient/detail.json/' + value
-                 });
-+                $('#medical_test_application_id').attr("value", value);
-             },
-             'click .like2': function (e, value, row) {
- 
-@@ -253,6 +257,18 @@ Lịch sử xét nghiệm
-                 value.substring(0, 10)
-             ]
-         }
-+        function buttonCheckMedicalTestApplication(value, row, index) {
-+            return [
-+                '<button class="btn btn-default" onClick="checkMedicalTestApplication(',
-+                value,
-+                ')">Kiểm tra</button>'
-+            ].join('');
-+        }
-+        function checkMedicalTestApplication(id) {
-+            $.get(baseUrl + '/checkMedicalTestApplication/' + id, function (data) {
-+                alert(data);
-+            });
-+        }
-     </script>		
- 
-     @stop
-\ No newline at end of file
diff --git a/resources/views/staff/COPD_test.blade.php b/resources/views/staff/COPD_test.blade.php
index 55c0c75..2e9a73b 100755
--- a/resources/views/staff/COPD_test.blade.php
+++ b/resources/views/staff/COPD_test.blade.php
@@ -204,7 +204,7 @@ Phiếu đo dung phế
             e.preventDefault();
 
             var originValue = '';
-            $('#COPDForm :input:not([type=hidden]):not([readonly]):not([disabled])').each(function (index) {
+            $('#COPDForm :input:not([type=hidden]):not([type=checkbox]):not([readonly]):not([disabled])').each(function (index) {
                 originValue += $(this).val();
             });
             originValue += {{ Auth::user()->id }};
diff --git a/resources/views/staff/COPD_test.blade.php.rej b/resources/views/staff/COPD_test.blade.php.rej
deleted file mode 100755
index 43a6c17..0000000
--- a/resources/views/staff/COPD_test.blade.php.rej
+++ /dev/null
@@ -1,88 +0,0 @@
-diff a/resources/views/staff/COPD_test.blade.php b/resources/views/staff/COPD_test.blade.php	(rejected hunks)
-@@ -69,7 +69,7 @@ Phiếu đo dung phế
-     @endif
- </div>
- 
--<form class="form-horizontal" action="{{ route('update-COPD-test-medical-info') }}" enctype="multipart/form-data" method="post">
-+<form class="form-horizontal" action="{{ route('update-COPD-test-medical-info') }}" enctype="multipart/form-data" method="post" id="COPDForm">
-     <h2 class="col-md-offset-3"> Thông tin bệnh nhân</h2>
-     <div class="form-group">
-         <label class="col-md-2 control-label" style="font-size: 16px"> Họ tên  :</label>
-@@ -183,16 +183,76 @@ Phiếu đo dung phế
-     <div class="form-group">
-         <input type="hidden" name="medicalID" value="<?php echo($medical_id); ?>">
-         <input type="hidden" name="_token" value="{{ csrf_token() }}">
-+        <input type="hidden" id="signatureValue" name="signatureValue">
-+		<input type="hidden" id="signDatetime" name="signDatetime">
-+		<input type="hidden" id="certificate" name="certificate">
-         <div class="col-md-offset-4">
-             <label>Hoàn thiện</label><input type="checkbox" value="1" name="checkSubmit" id="checkSubmit">
-             <!--<button type="button" onclick="getApi()" class="btn btn-success btn-lg">Bắt đầu đo kết quả</button>-->
--            <button type="submit" class="btn btn-primary btn-lg">Lưu kết quả </button>
-+            <button class="btn btn-primary btn-lg" id="signBtn">Ký số phiếu đo</button>
-+            <button class="btn btn-primary btn-lg" disabled id="saveBtn">Lưu kết quả </button>
- 
- 
-         </div>
-     </div>
- 
- </form>
-+<script>
-+    $(document).ready(function(){
-+
-+        $('#signBtn').on('click', function(e){
-+            e.preventDefault();
-+
-+            var originValue = '';
-+            $('#COPDForm :input:not([type=hidden]):not([readonly])').each(function (index) {
-+                originValue += $(this).val();
-+            });
-+            originValue += {{ Auth::user()->id }};
-+            var currentdate = new Date();
-+            var time = currentdate.getHours() + ":"
-+                + currentdate.getMinutes() + ":"
-+                + currentdate.getSeconds()
-+                + ' '
-+                + currentdate.getDate() + "/"
-+                + (currentdate.getMonth()+1)  + "/"
-+                + currentdate.getFullYear();
-+			originValue += time;
-+			//console.log(originValue);
-+
-+            window.postMessage({
-+                type: "CREATE_SIGNATURE_REQUEST",
-+                originValue: originValue
-+            }, "*");
-+
-+            window.addEventListener("message", function (event) {
-+                if (event.source != window)
-+                    return;
-+
-+                if (event.data.type && (event.data.type == "CREATE_SIGNATURE_RESPONSE")) {
-+                    if (event.data.success) {
-+                        if (event.data.signature !== null) {
-+                            alert("Đã ký phiếu đo!");
-+                            $('#signatureValue').val(event.data.signature);
-+                            $('#signDatetime').val(time);
-+                            $('#certificate').val(event.data.certificate);
-+                            $('#COPDForm :input:not([type=hidden]):not([readonly])').each(function (index) {
-+                                $(this).prop("readonly", true);
-+                            });
-+                            $('#signBtn').prop("disabled", true);
-+                            $('#saveBtn').prop("disabled", false);
-+                        } else {
-+                            alert("Chứng thư đã chọn không được dùng để ký!");
-+                        }
-+                    }
-+                    else {
-+                        alert("Ký số phiếu đo không thành công!");
-+                    }
-+                }
-+            })
-+        });
-+
-+    });
-+</script>
- <script>
- //    function load() {
- //        $.ajax({
diff --git a/resources/views/staff/medical_test.blade.php b/resources/views/staff/medical_test.blade.php
index 0c5b1e9..e57b341 100755
--- a/resources/views/staff/medical_test.blade.php
+++ b/resources/views/staff/medical_test.blade.php
@@ -142,7 +142,7 @@
             e.preventDefault();
 
             var originValue = '';
-            $('#medicalTestForm :input:not([type=hidden]):not([readonly]):not([disabled])').each(function (index) {
+            $('#medicalTestForm :input:not([type=hidden]):not([type=checkbox]):not([readonly]):not([disabled])').each(function (index) {
                 originValue += $(this).val();
             });
             originValue += {{ Auth::user()->id }};
diff --git a/resources/views/staff/medical_test.blade.php.rej b/resources/views/staff/medical_test.blade.php.rej
deleted file mode 100755
index d21365f..0000000
--- a/resources/views/staff/medical_test.blade.php.rej
+++ /dev/null
@@ -1,86 +0,0 @@
-diff a/resources/views/staff/medical_test.blade.php b/resources/views/staff/medical_test.blade.php	(rejected hunks)
-@@ -69,7 +69,7 @@
-     @endif
- </div>
- 
--<form class="form-horizontal" action="{{ route('update-test-medical-info') }}" enctype="multipart/form-data" method="post">
-+<form class="form-horizontal" action="{{ route('update-test-medical-info') }}" enctype="multipart/form-data" method="post" id="medicalTestForm">
- <h2 class="col-md-offset-3"> Thông tin bệnh nhân</h2>
-     <div class="form-group">
-         <label class="col-md-2 control-label" style="font-size: 16px"> Họ tên  :</label>
-@@ -122,14 +122,73 @@
-         <div class="form-group">
-         <input type="hidden" name="medicalID" value="<?php echo($medical_id); ?>">
-         <input type="hidden" name="_token" value="{{ csrf_token() }}">
-+        <input type="hidden" id="signatureValue" name="signatureValue">
-+		<input type="hidden" id="signDatetime" name="signDatetime">
-+		<input type="hidden" id="certificate" name="certificate">
-         	<div class="col-md-offset-4">
-                     <label>Hoàn thiện</label><input type="checkbox" value="1" name="checkSubmit" id="checkSubmit">
--        		<button type="submit" class="btn btn-primary btn-lg">Lưu kết quả </button>
-+                <button class="btn btn-primary btn-lg" id="signBtn">Ký số đơn khám</button>
-+        		<button class="btn btn-primary btn-lg" disabled id="saveBtn">Lưu kết quả </button>
-                        
-                       
-         	</div>
-         </div>
-       
-     </form>
-+<script>
-+    $(document).ready(function(){
- 
-+        $('#signBtn').on('click', function(e){
-+            e.preventDefault();
-+
-+            var originValue = '';
-+            $('#medicalTestForm :input:not([type=hidden]):not([readonly])').each(function (index) {
-+                originValue += $(this).val();
-+            });
-+            originValue += {{ Auth::user()->id }};
-+            var currentdate = new Date();
-+            var time = currentdate.getHours() + ":"
-+                + currentdate.getMinutes() + ":"
-+                + currentdate.getSeconds()
-+                + ' '
-+                + currentdate.getDate() + "/"
-+                + (currentdate.getMonth()+1)  + "/"
-+                + currentdate.getFullYear();
-+			originValue += time;
-+			//console.log(originValue);
-+
-+            window.postMessage({
-+                type: "CREATE_SIGNATURE_REQUEST",
-+                originValue: originValue
-+            }, "*");
-+
-+            window.addEventListener("message", function (event) {
-+                if (event.source != window)
-+                    return;
-+
-+                if (event.data.type && (event.data.type == "CREATE_SIGNATURE_RESPONSE")) {
-+                    if (event.data.success) {
-+                        if (event.data.signature !== null) {
-+                            alert("Đã ký đơn khám!");
-+                            $('#signatureValue').val(event.data.signature);
-+                            $('#signDatetime').val(time);
-+                            $('#certificate').val(event.data.certificate);
-+                            $('#medicalTestForm :input:not([type=hidden]):not([readonly])').each(function (index) {
-+                                $(this).prop("readonly", true);
-+                            });
-+                            $('#signBtn').prop("disabled", true);
-+                            $('#saveBtn').prop("disabled", false);
-+                        } else {
-+                            alert("Chứng thư đã chọn không được dùng để ký!");
-+                        }
-+                    }
-+                    else {
-+                        alert("Ký số đơn khám không thành công!");
-+                    }
-+                }
-+            })
-+        });
-+
-+    });
-+</script>
- @stop
-\ No newline at end of file
-- 
2.19.0.windows.1

